<!doctype html>
<meta charset="utf-8">
<title>fun</title>
<body>
    <script src="pixi.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        var boardState;
        var socket = io();
        var mouseDown = false;
        
        var mouseLoc = {x: 0, y: 0};
        //Aliases
        var Container = PIXI.Container,
            autoDetectRenderer = PIXI.autoDetectRenderer,
            loader = PIXI.loader,
            resources = PIXI.loader.resources,
            TextureCache = PIXI.utils.TextureCache,
            Sprite = PIXI.Sprite;
        //Create a Pixi stage and renderer and add the 
        //renderer.view to the DOM
        var stage = new Container(),
            renderer = autoDetectRenderer(900, 900);
        document.body.appendChild(renderer.view);
        
        var tileHeight = 103,
            tileWidth = 88;
        
        //this is shitty way to do this. need better way
        var tiles = [];
        var peasants = [];
        var trees = [];
        var bases = [];
        
        var screenLoc = {x: 0, y: 0 };
        var screenLok = {x: 0, y: 0 };
        //Use Pixi's built-in `loader` module to load an image
        loader
            .add("images/ground.png")
            .add("images/tree.png")
            .add("images/peasant.png")
            .add("images/base.png")
            .load(setup);
        //This `setup` function will run when the image has loaded
        function setup() {
              
        }
        
        socket.on('board state', function(board){
            boardState = board;
            drawBoard();
            console.log('updating board');
        });
        
        //TODO use config file for boardsize
        function drawBoard(){
            for(var j = 0; j < 7; j++){
                for(var i = 0; i < 7; i++){
                    var tileNmb = i + j * 7;

                      var ter = new Sprite(resources["images/ground.png"].texture);
                      if(typeof tiles[tileNmb] === "undefined"){
                          if(boardState[tileNmb].terrain == 'grass'){
                              ter = new Sprite(resources["images/ground.png"].texture);
                          }
                          tiles[tileNmb] = ter;
                    }
                    tiles[tileNmb].width = tileWidth;
                    tiles[tileNmb].height = tileHeight;
                    tiles[tileNmb].x = i * tileWidth + ((j % 2) * tileWidth / 2 - screenLoc.x);
                    tiles[tileNmb].y = j * (tileHeight - (Math.sin(Math.PI/6) * (tileHeight / 2))) - screenLoc.y;
                    stage.addChild(tiles[tileNmb]);   
                    if(boardState[tileNmb].standing == 'peasant'){
                        if(typeof peasants[tileNmb] === "undefined"){
                            console.log('drawing peasant'); 
                            peasants[tileNmb] = new Sprite(resources["images/peasant.png"].texture);
                        }
                        peasants[tileNmb].x = tiles[tileNmb].x + tileWidth / 2 - peasants[tileNmb].width / 2;
                        peasants[tileNmb].y = tiles[tileNmb].y + tileHeight / 2 - peasants[tileNmb].height / 2; 
                        stage.addChild(peasants[tileNmb]);
                    }else if(boardState[tileNmb].standing == 'tree'){
                        if(typeof trees[tileNmb] === "undefined"){
                            console.log('drawing trees');
                            trees[tileNmb] = [];
                            var yAccumulation = tileHeight / 4;
                            var i = 0;
                            while(yAccumulation < tileHeight - tileHeight / 4){
                                trees[tileNmb][i] = new Sprite(resources["images/tree.png"].texture);
                                yAccumulation += randomInt(0, 5);
                                trees[tileNmb][i].yOffSet = yAccumulation;
                                trees[tileNmb][i].xOffSet = randomInt(trees[tileNmb][i].width, tileWidth - trees[tileNmb][i].width / 2);
                                trees[tileNmb][i].x = tiles[tileNmb].x + trees[tileNmb][i].xOffSet - trees[tileNmb][i].width;
                                trees[tileNmb][i].y = tiles[tileNmb].y + trees[tileNmb][i].yOffSet - trees[tileNmb][i].height;
                                stage.addChild(trees[tileNmb][i]);
                                i++; 
                            }
                        }else{
                            for(var i = 0; i < trees[tileNmb].length; i++){
                                trees[tileNmb][i].x = tiles[tileNmb].x + trees[tileNmb][i].xOffSet- trees[tileNmb][i].width;
                                trees[tileNmb][i].y = tiles[tileNmb].y + trees[tileNmb][i].yOffSet - trees[tileNmb][i].height;
                                stage.addChild(trees[tileNmb][i]);
                            }
                        }
                    }else if(boardState[tileNmb].standing == 'base'){
                        if(typeof bases[tileNmb] === "undefined"){
                            console.log('drawing base'); 
                            bases[tileNmb] = new Sprite(resources["images/base.png"].texture);
                        }
                        bases[tileNmb].x = tiles[tileNmb].x + tileWidth / 2 - bases[tileNmb].width / 2;
                        bases[tileNmb].y = tiles[tileNmb].y + tileHeight / 2 - bases[tileNmb].height / 2; 
                        stage.addChild(bases[tileNmb]);
                    }
                }
            }
            renderer.render(stage);
        }
            
            
        window.addEventListener('mousemove', function(event) {
            if(mouseDown){
                screenLoc.x = screenLok.x + mouseLoc.x - event.clientX;
                screenLoc.y = screenLok.y + mouseLoc.y - event.clientY;
                drawBoard();
            }
         });
        
        window.addEventListener('mousedown', function(event) {
            mouseDown = true;
            mouseLoc.x = event.clientX;
            mouseLoc.y = event.clientY;
        });
        
        window.addEventListener('mouseup', function(event) {
            mouseDown = false;
            screenLok.x = screenLoc.x;
            screenLok.y = screenLoc.y;
        });
        
        function randomInt(min, max){
            return Math.floor(Math.random() * (max - min) + min) + 1;
        }

    </script>
</body>
